date: 2022-05-07 11:42:17
uuid: 07342029-7876-47c6-9e51-e86a25d91f2d
tgid: 147
tags: channel
----

<p>Бачили який збір грошей <a href="https://dou.ua/forums/topic/37811/">ДОУ влаштували</a>? Вийшло дуже кльово, імхо. :) Я там трохи взяти участі, зробив власне механізм трекінгу грошей.</p>

<p>Почнімо з карток, бо вони цікавіші. На сторінці ПЖ про донейти є посилання на фонді, через яке можна відправити будь-які кошти — але немає жодного механізму трекінгу того, звідки людина прийшла. </p>

<p>Тож я створив невеличкий сервіс, якому в аргументи можна передати суму, валюту і тег (можна подивитись на посилання на сторінці збору коштів ДОУ) — а він генерує спеціальний <code>order_id</code> виду <code>cba-123356-#some-tag1~#some-tag2</code>. Авжеж, як <em>справжній</em> програміст, я одразу зробив, щоб можна було багато тегів задати. :) Тобто йде до фонді по апі та генерує замовлення с заданими параметрами, а потім туди відправляє браузер — це тому на сторінці фонді вже неможливо змінити суму.</p>

<p>А як дістати ті дані? Ну ви напевно пам‘ятаєте, що я звіт зробив, то там тепер вже є <a href="https://github.com/comebackalive/finreport/blob/master/src/cba/finreport/fondy.clj">автооновлення даних з фонді</a> та в тому числі <a href="https://github.com/comebackalive/finreport/blob/903ae86d9696dda67c8fa217fc14a87bf81b05fe/src/cba/finreport/process.clj#L63">парсинг тегів</a> з ідентифікатора замовлення.</p>

<p>А потім ці теги складаються в поле типу <code>text[]</code> в постгрес, ну й рибка в сітці. :) Зробив питання у метабейзі просто на суму грошей, віддав апі до нього — а Ігор з ДОУ зробив прикольну візуалізацію того і вийшло супер.</p>

<p>Що відбувається з банківськими переказами можна здогадатися, думаю — та сама регулярка ловить теги з коментаря. Одна проблема — оновлення робиться руками раз на день і тому відчуття змагання не таке яскраве.</p>

<p>Гарно, що це вже дуже повторюване, тож можна робити в різних варіантах. Воно, власне, ще непогано спрацювало як тест системи проєктів для нового сайту ПЖ. :)</p>

<p>Є насправді механізм передачі даних через спеціальне поле, але такі дані не побачиш в ікселевських звітах, що різко знижує їх цінність. А ще можна влаштувати ріалтайм замість оновлення по крону раз на 5 хвилин, за допомогою колбеків від фонді — але це підвищує складність системи, тобто стійкість буде не та і мені прийдеться звертати більше уваги на те, щоб воно працювало. :)</p>

<p><strong>UPD.</strong> Ще додатково <a href="https://report.comebackalive.in.ua/public/dashboard/a297a107-6740-4b69-9603-f91703f7afba?tag=DOU.ua">дешборд</a> зробив.</p>